<!-- ✅ Подключение WebApp Telegram -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const tg = window.Telegram.WebApp;

    if (!tg || !tg.sendData) {
      alert("❗ Telegram WebApp не загружен. Открой форму через Telegram.");
      return;
    }

    tg.expand();

    function getSelectedValues(id) {
      return Array.from(document.querySelectorAll(`#${id} .selected`)).map(el => el.textContent.trim());
    }

    // Отправка формы
    document.querySelector('.submit').addEventListener('click', function (e) {
      e.preventDefault();

      const inputs = document.querySelectorAll('input');
      const textareas = document.querySelectorAll('textarea');
      const consent = document.querySelector('input[type="checkbox"]').checked;

      if (!consent) {
        alert("❗ Необходимо согласие на обработку персональных данных.");
        return;
      }

      const formData = {
        parent: inputs[0].value.trim(),                    // LEADTEX: parent — ФИО родителя
        phone: inputs[1].value.trim(),                     // LEADTEX: phone — Телефон
        child_age: inputs[2].value.trim(),                 // LEADTEX: child_age — Возраст ребёнка
        contraindications: textareas[0].value.trim(),      // LEADTEX: contraindications — Противопоказания
        sport_experience: textareas[1].value.trim(),       // LEADTEX: sport_experience — Опыт в спорте
        goals: getSelectedValues('goals'),                 // LEADTEX: goals — Цели (массив)
        preferred_day: getSelectedValues('days')[0] || '', // LEADTEX: preferred_day — Удобный день
        source: getSelectedValues('source')[0] || '',      // LEADTEX: source — Источник
        extra_info: textareas[2].value.trim(),             // LEADTEX: extra_info — Дополнительная информация
        consent: consent                                   // LEADTEX: consent — true/false
      };

      tg.sendData(JSON.stringify(formData));
      tg.close();
    });

    // Single-select
    function enforceSingleSelection(groupId) {
      const group = document.querySelector(`#${groupId}`);
      group.querySelectorAll('.button-tile').forEach(tile => {
        tile.addEventListener('click', () => {
          group.querySelectorAll('.button-tile').forEach(btn => btn.classList.remove('selected'));
          tile.classList.add('selected');
        });
      });
    }

    enforceSingleSelection('days');
    enforceSingleSelection('source');

    // Multi-select
    document.querySelectorAll('#goals .button-tile').forEach(tile => {
      tile.addEventListener('click', () => {
        tile.classList.toggle('selected');
      });
    });
  });
</script>

<!-- ✅ HTML-форма -->
<form>
  <!-- LEADTEX: parent - ФИО родителя -->
  <label>ФИО родителя (законного представителя):</label>
  <input type="text" required />

  <!-- LEADTEX: phone - Телефон -->
  <label>Контактный телефон для связи:</label>
  <input type="tel" required />

  <!-- LEADTEX: child_age - Возраст ребёнка -->
  <label>Возраст ребёнка:</label>
  <input type="number" required />

  <!-- LEADTEX: contraindications - Противопоказания -->
  <label>Имеются ли у ребёнка противопоказания к физическим нагрузкам?</label>
  <textarea rows="2"></textarea>

  <!-- LEADTEX: sport_experience - Спортивный опыт -->
  <label>Опыт занятий спортом (указать каким, если имеется):</label>
  <textarea rows="2"></textarea>

  <!-- LEADTEX: goals - Цели (массив) -->
  <label>Цель записи на занятия (можно выбрать несколько):</label>
  <div class="button-group-grid" id="goals">
    <div class="button-tile">Общее физическое развитие</div>
    <div class="button-tile">Самооборона и дисциплина</div>
    <div class="button-tile">Спортивная карьера</div>
    <div class="button-tile">Психологический рост</div>
    <div class="button-tile">Социализация ребенка</div>
    <div class="button-tile">Изучение восточные боевых искусств</div>
    <div class="button-tile">Эмоциональная регуляция</div>
    <div class="button-tile">Другое</div>
  </div>

  <!-- LEADTEX: preferred_day - Удобный день -->
  <label>Выберите удобный день для записи:</label>
  <div class="button-group-vertical" id="days">
    <div class="button-tile">Понедельник (18:00-19:20)</div>
    <div class="button-tile">Среда (18:00-19:20)</div>
    <div class="button-tile">Пятница (18:00-19:20)</div>
  </div>

  <!-- LEADTEX: source - Источник -->
  <label>Как вы узнали о нас?</label>
  <div class="button-group-grid" id="source">
    <div class="button-tile">Социальные сети</div>
    <div class="button-tile">Реклама в интернете</div>
    <div class="button-tile">Рекомендация друзей</div>
    <div class="button-tile">Другой способ</div>
  </div>

  <!-- LEADTEX: extra_info - Дополнительная информация -->
  <label>Дополнительная информация:</label>
  <textarea rows="3"></textarea>

  <!-- LEADTEX: consent - Согласие (true/false) -->
  <label>Согласие на обработку персональных данных:</label>
  <div class="checkbox-wrapper">
    <input type="checkbox" required />
    <label><em>я даю согласие на обработку персональных данных</em></label>
  </div>

  <button type="submit" class="submit">Записаться</button>
</form>
